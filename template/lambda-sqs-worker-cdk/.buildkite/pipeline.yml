agents:
  queue: <%- prodBuildkiteQueueName %>

configs:
  plugins:
    - &aws-sm
      seek-oss/aws-sm#v2.3.2:
        env:
          NPM_READ_TOKEN: arn:aws:secretsmanager:ap-southeast-2:987872074697:secret:npm/npm-read-token

    - &docker-ecr-cache
      seek-oss/docker-ecr-cache#v2.1.1: &docker-ecr-cache-defaults
        cache-on: pnpm-lock.yaml
        secrets: id=npm,src=tmp/.npmrc

    - &private-npm
      seek-oss/private-npm#v1.2.0:
        env: NPM_READ_TOKEN
        output-path: tmp/

  base-steps:
    - &deploy
      commands:
        - echo '+++ pnpm install --offline'
        - pnpm install --offline
        - echo '+++ pnpm run deploy'
        - pnpm run deploy
      concurrency: 1
      plugins:
        - *aws-sm
        - *private-npm
        - *docker-ecr-cache
        - docker-compose#v4.16.0:
            dependencies: false
            run: app
            propagate-environment: true
      retry:
        manual:
          # Only use this if you need to roll back a deployment ASAP.
          # Always follow up with a proper revert or fix in Git history.
          permit_on_passed: true

steps:
  - label: ğŸ§ª Test, Lint & Build
    commands:
      - echo '+++ pnpm install --offline'
      - pnpm install --offline
      - echo '+++ pnpm run test:ci'
      - pnpm run test
      - echo '--- pnpm run lint'
      - pnpm run lint
    env:
      GET_GITHUB_TOKEN: please
    plugins:
      - *aws-sm
      - *private-npm
      - *docker-ecr-cache
      - docker-compose#v4.16.0:
          run: app
          propagate-environment: true
    timeout_in_minutes: 10

  - agents:
      queue: <%- devBuildkiteQueueName %>
    branches: '!renovate-*'
    label: ğŸ§–â€â™€ï¸ Warm Dev
    command: ':'
    plugins:
      - *aws-sm
      - *private-npm
      - seek-oss/docker-ecr-cache#v2.1.1:
          <<: *docker-ecr-cache-defaults
          skip-pull-from-cache: true

  - wait
  - block: ğŸ™‹ğŸ»â€â™€ï¸ Deploy Dev
    branches: '!${BUILDKITE_PIPELINE_DEFAULT_BRANCH}'

  - <<: *deploy
    agents:
      queue: <%- devBuildkiteQueueName %>
    env:
      ENVIRONMENT: dev
    label: ğŸ¤ Deploy Dev
    concurrency_group: '<%- repoName %>/deploy/dev'
    key: deploy-dev

  - block: ğŸ™‹ğŸ»â€â™€ï¸ Deploy Dev (Hotswap)
    key: deploy-dev-hotswap-block
    branches: '!${BUILDKITE_PIPELINE_DEFAULT_BRANCH}'

  - <<: *deploy
    branches: '!${BUILDKITE_PIPELINE_DEFAULT_BRANCH}'
    depends_on: deploy-dev-hotswap-block
    agents:
      queue: <%- devBuildkiteQueueName %>
    env:
      ENVIRONMENT: dev
    commands:
      - echo '+++ pnpm install --offline'
      - pnpm install --offline
      - echo '+++ pnpm run deploy:hotswap'
      - pnpm run deploy:hotswap
    label: ğŸ¤ Deploy Dev (Hotswap)
    concurrency_group: '<%- repoName %>/deploy/dev'

  - <<: *deploy
    env:
      ENVIRONMENT: prod
    label: ğŸš€ Deploy Prod
    branches: ${BUILDKITE_PIPELINE_DEFAULT_BRANCH}
    concurrency_group: '<%- repoName %>/deploy/prod'
    depends_on: deploy-dev
